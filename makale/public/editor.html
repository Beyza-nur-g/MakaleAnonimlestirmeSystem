<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit√∂r Paneli</title>
    <link rel="stylesheet" href="style.css"> <!-- CSS dosyasƒ± buraya baƒülandƒ± -->
</head>
<body>
    <div class="container">
        <h2 class="title">Edit√∂r Paneli</h2>

        <!-- üìå Hakem Ekleme -->
        <div class="form-container">
            <h3>Yeni Hakem Ekle</h3>
            <div class="form-group">
                <label for="reviewerName">ƒ∞sim:</label>
                <input type="text" id="reviewerName" placeholder="Hakem Adƒ±" required>
            </div>
            <div class="form-group">
                <label for="reviewerExpertise">Uzmanlƒ±k Alanƒ±:</label>
                <input type="text" id="reviewerExpertise" placeholder="Uzmanlƒ±k Alanƒ±" required>
            </div>
            <button class="btn" onclick="addReviewer()">Ekle</button>
        </div>

        <div class="article-section">
            <h2>Makaleler</h2>
            <div class="filter-group">
                <select id="articleStatusFilter">
                    <option value="">T√ºm Makaleler</option>
                    <option value="Hakem Bekleniyor">Hakem Bekleniyor</option>
                    <option value="Hakeme Atandƒ±">Hakeme Atandƒ±</option>
                    <option value="Deƒüerlendirildi">Deƒüerlendirildi</option>
                    <option value="Onaylandƒ±">Onaylandƒ±</option>
                    <option value="Reddedildi">Reddedildi</option>
                </select>
                <button class="btn" onclick="loadArticles()">Listele</button>
            </div>
        </div>

        <div id="articlesContainer" class="articles-container"></div>
    </div>

    <script>
        async function addReviewer() {
            const name = document.getElementById("reviewerName").value.trim();
            const expertise = document.getElementById("reviewerExpertise").value.trim();

            if (!name || !expertise) {
                alert("L√ºtfen hakem adƒ± ve uzmanlƒ±k alanƒ±nƒ± giriniz!");
                return;
            }

            const response = await fetch("/api/editor/addReviewer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, expertise })
            });

            const data = await response.json();
            if (response.ok) {
                alert(data.message);
                document.getElementById("reviewerName").value = "";
                document.getElementById("reviewerExpertise").value = "";
            } else {
                alert(`Hata: ${data.error}`);
            }
        }

        async function loadArticles() {
            const status = document.getElementById("articleStatusFilter").value;
            const res = await fetch(`/api/editor/articles?status=${status}`);
            const articles = await res.json();
            const container = document.getElementById("articlesContainer");
            container.innerHTML = "";

            articles.forEach(article => {
                let card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    <p><strong>Takip No:</strong> ${article.trackingNumber}</p>
                    <p><strong>Konu:</strong> ${article.articleTopic}</p>
                    <p><strong>Durum:</strong> ${article.status}</p>

                    <h3>Makale G√∂r√ºnt√ºleme ve ƒ∞ndirme</h3>
                    <a href="http://localhost:5000${article.pdfPath}" target="_blank">
                        <button>üìÑ Orijinal Makaleyi A√ß</button>
                    </a>
                    <a href="http://localhost:5000${article.pdfPath}" download>
                        <button>üìÇ Orijinal Makaleyi ƒ∞ndir</button>
                    </a>

                    ${article.anonPdfPath ? `
                        <a href="http://localhost:5000${article.anonPdfPath.startsWith('/') ? article.anonPdfPath : '/' + article.anonPdfPath}" target="_blank">
                            <button>üìÑ Anonimle≈ütirilmi≈ü Makaleyi A√ß</button>
                        </a>

                        <a href="http://localhost:5000${article.anonPdfPath}" download>
                            <button>üìÇ Anonimle≈ütirilmi≈ü Makaleyi ƒ∞ndir</button>
                        </a>
                    ` : ""}

                    ${article.status === "Hakem Bekleniyor" ? `
                        <h4>Hakem Atama</h4>
                        <select id="reviewerSelect-${article._id}"></select>
                        <button onclick="assignReviewer('${article._id}')">Hakem Ata</button>

                        <h4>Anonimle≈ütirilecek Bilgiler:</h4>
                        <label><input type="checkbox" id="anonymizeName-${article._id}"> Ad-Soyad</label>
                        <label><input type="checkbox" id="anonymizeEmail-${article._id}"> E-posta</label>
                        <label><input type="checkbox" id="anonymizeInstitution-${article._id}"> Kurum</label>
                        <button onclick="anonymizeArticle('${article._id}')">Anonimle≈ütir</button>
                    ` : ""}

                    ${article.status === "Hakeme Atandƒ±" ? `
                        <h4>Hakem Deƒüi≈ütir</h4>
                        <select id="changeReviewerSelect-${article._id}"></select>
                        <button onclick="changeReviewer('${article._id}')">Hakemi Deƒüi≈ütir</button>
                    ` : ""}

                    ${article.status === "Deƒüerlendirildi" ? `
                        <h4>Hakem Deƒüerlendirmesi</h4>
                        <p><strong>Sonu√ß:</strong> ${article.reviewResult}</p>
                        <p><strong>Yorum:</strong> ${article.additionalComments || "Yorum belirtilmemi≈ü"}</p>
                        <button onclick="updateStatus('${article._id}', 'Onaylandƒ±')">‚úÖ Onayla</button>
                        <button onclick="updateStatus('${article._id}', 'Reddedildi')">‚ùå Reddet</button>
                        <button onclick="removeAnonymization('${article._id}')">üîì Anonimliƒüi Kaldƒ±r</button>
                    ` : ""}
                `;
                container.appendChild(card);

                if (article.status === "Hakem Bekleniyor") {
                    loadReviewers(`reviewerSelect-${article._id}`, article.articleTopic);
                }

                if (article.status === "Hakeme Atandƒ±") {
                    loadReviewers(`changeReviewerSelect-${article._id}`, article.reviewer);
                }
            });
        }

        async function loadReviewers(selectId, topic=null, excludeReviewerId = null) {
            let url = "/api/editor/reviewers";
            if (topic) {
                url += `?topic=${encodeURIComponent(topic)}`;
            }

            const res = await fetch(url);
            const reviewers = await res.json();
            const select = document.getElementById(selectId);

            const filtered = excludeReviewerId
                ? reviewers.filter(reviewer => reviewer._id !== excludeReviewerId)
                : reviewers;

            if (filtered.length === 0) {
                select.innerHTML = '<option value="">Uygun Hakem Bulunamadƒ±</option>';
            } else {
                select.innerHTML = filtered.map(reviewer => `<option value="${reviewer._id}">${reviewer.name} (${reviewer.expertise})</option>`).join("");
            }
        }

        async function assignReviewer(articleId) {
            const reviewerId = document.getElementById(`reviewerSelect-${articleId}`).value;
            await fetch("/api/editor/assignReviewer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ articleId, reviewerId })
            });
            loadArticles();
        }

        async function changeReviewer(articleId) {
            const newReviewerId = document.getElementById(`changeReviewerSelect-${articleId}`).value;
            await fetch("/api/editor/changeReviewer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ articleId, newReviewerId })
            });
            alert("Hakem ba≈üarƒ±yla deƒüi≈ütirildi!");
            loadArticles();
        }

        async function anonymizeArticle(articleId) {
            const name = document.getElementById(`anonymizeName-${articleId}`).checked;
            const email = document.getElementById(`anonymizeEmail-${articleId}`).checked;
            const institution = document.getElementById(`anonymizeInstitution-${articleId}`).checked;

            if (!name && !email && !institution) {
                alert("L√ºtfen en az bir anonimle≈ütirilecek bilgi se√ßin.");
                return;
            }

            await fetch("/api/editor/anonymize", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ articleId, options: { name, email, institution } })
            });

            alert("Makale anonimle≈ütirildi!");
            loadArticles();
        }

        async function removeAnonymization(articleId) {
            try {
                const response = await fetch("/api/editor/decryptAnonymized", {
                   method: "POST",
                   headers: { "Content-Type": "application/json" },
                   body: JSON.stringify({ articleId })
                });

                const result = await response.json();
                if (response.ok) {
                   alert("Anonimlik kaldƒ±rƒ±ldƒ± ve PDF g√ºncellendi!");
                   loadArticles();
                } else {
                   alert("Hata: " + result.error);
                }
            } catch (err) {
                console.error("‚ùå Fetch isteƒüi ba≈üarƒ±sƒ±z:", err);
                alert("Sunucuya ula≈üƒ±rken bir hata olu≈ütu!");
            }
        }

        async function updateStatus(articleId, newStatus) {
            await fetch("/api/editor/updateStatus", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ articleId, newStatus })
            });
            loadArticles();
        }

        loadArticles();
    </script>
</body>
</html>
